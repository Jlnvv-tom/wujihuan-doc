import{_ as i,c as a,o as n,aj as l}from"./chunks/framework.CynFBi0q.js";const E=JSON.parse('{"title":"MySQL 数据库应用指南：第15章 MySQL高可用架构实践","description":"","frontmatter":{},"headers":[],"relativePath":"handbook/mysql/chapter_15.md","filePath":"handbook/mysql/chapter_15.md","lastUpdated":1769350105000}'),e={name:"handbook/mysql/chapter_15.md"};function p(h,s,t,r,k,d){return n(),a("div",null,[...s[0]||(s[0]=[l(`<h1 id="mysql-数据库应用指南-第15章-mysql高可用架构实践" tabindex="-1">MySQL 数据库应用指南：第15章 MySQL高可用架构实践 <a class="header-anchor" href="#mysql-数据库应用指南-第15章-mysql高可用架构实践" aria-label="Permalink to “MySQL 数据库应用指南：第15章 MySQL高可用架构实践”">​</a></h1><p>在生产环境中，数据库的“不可用”意味着业务直接中断——无论是服务器宕机、网络故障，还是数据损坏，都会造成不可估量的损失。高可用（High Availability，HA）架构的核心目标是<strong>最大限度减少数据库停机时间</strong>，保障业务持续可用。本章将从高可用核心需求、主从复制、组复制（MGR），到故障切换和工具选型，全面讲解 MySQL 高可用架构的设计与落地实践。</p><h2 id="_15-1-高可用架构的核心需求与评估指标" tabindex="-1">15.1 高可用架构的核心需求与评估指标 <a class="header-anchor" href="#_15-1-高可用架构的核心需求与评估指标" aria-label="Permalink to “15.1 高可用架构的核心需求与评估指标”">​</a></h2><h3 id="_15-1-1-高可用的核心需求" tabindex="-1">15.1.1 高可用的核心需求 <a class="header-anchor" href="#_15-1-1-高可用的核心需求" aria-label="Permalink to “15.1.1 高可用的核心需求”">​</a></h3><p>企业级 MySQL 高可用架构需满足以下核心诉求，缺一不可：</p><ol><li><strong>故障自动检测</strong>：快速发现主库宕机、复制异常等故障；</li><li><strong>故障自动切换</strong>：无需人工介入，秒级将业务流量切换到备用节点；</li><li><strong>数据一致性</strong>：切换后数据无丢失、无错乱，满足业务数据完整性要求；</li><li><strong>性能无显著下降</strong>：高可用架构不能过度牺牲数据库性能（如复制延迟、集群开销）；</li><li><strong>可扩展性</strong>：架构支持节点扩容，适配业务增长；</li><li><strong>运维成本可控</strong>：避免过度复杂的架构，降低运维难度。</li></ol><h3 id="_15-1-2-核心评估指标" tabindex="-1">15.1.2 核心评估指标 <a class="header-anchor" href="#_15-1-2-核心评估指标" aria-label="Permalink to “15.1.2 核心评估指标”">​</a></h3><p>衡量高可用架构的效果，需聚焦以下关键指标：</p><table tabindex="0"><thead><tr><th>指标</th><th>定义</th><th>企业级目标</th></tr></thead><tbody><tr><td><strong>RTO（恢复时间目标）</strong></td><td>故障发生到业务恢复的时长</td><td>≤30秒（核心业务）/ ≤5分钟（非核心业务）</td></tr><tr><td><strong>RPO（恢复点目标）</strong></td><td>故障后允许丢失的数据量/时间</td><td>≤0秒（零数据丢失）/ ≤5秒（容忍少量丢失）</td></tr><tr><td><strong>可用性（Uptime）</strong></td><td>年度可用时长占比</td><td>≥99.99%（即年度停机≤52.56分钟）</td></tr><tr><td><strong>复制延迟</strong></td><td>从库与主库的数据同步延迟</td><td>≤1秒（核心业务）/ ≤5秒（非核心业务）</td></tr><tr><td><strong>切换成功率</strong></td><td>故障切换的成功次数/总切换次数</td><td>100%（需通过演练验证）</td></tr></tbody></table><h3 id="_15-1-3-常见高可用架构选型" tabindex="-1">15.1.3 常见高可用架构选型 <a class="header-anchor" href="#_15-1-3-常见高可用架构选型" aria-label="Permalink to “15.1.3 常见高可用架构选型”">​</a></h3><p>不同业务规模适配不同的高可用架构，核心选型对比：</p><table tabindex="0"><thead><tr><th>架构类型</th><th>适用场景</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>主从复制 + Keepalived</td><td>中小业务（单主单从/单主多从）</td><td>部署简单、成本低</td><td>手动切换（或半自动化）、复制延迟可能导致数据丢失</td></tr><tr><td>主从复制 + MHA</td><td>中大型业务（单主多从）</td><td>自动故障切换、零数据丢失（配置得当）</td><td>仅支持单主，扩容复杂</td></tr><tr><td>MySQL MGR（组复制）</td><td>核心业务（多主/单主集群）</td><td>原生高可用、数据强一致、自动切换</td><td>部署复杂、对网络要求高、性能开销略大</td></tr><tr><td>云厂商托管集群（RDS）</td><td>所有业务</td><td>免运维、自动切换、按需扩容</td><td>成本高、定制化能力弱</td></tr></tbody></table><h2 id="_15-2-mysql主从复制的原理与配置" tabindex="-1">15.2 MySQL主从复制的原理与配置 <a class="header-anchor" href="#_15-2-mysql主从复制的原理与配置" aria-label="Permalink to “15.2 MySQL主从复制的原理与配置”">​</a></h2><p>主从复制是 MySQL 高可用的基础，也是最常用的架构——主库负责写操作，从库负责读操作，既实现读写分离，又能在主库故障时切换到从库。</p><h3 id="_15-2-1-主从复制核心原理" tabindex="-1">15.2.1 主从复制核心原理 <a class="header-anchor" href="#_15-2-1-主从复制核心原理" aria-label="Permalink to “15.2.1 主从复制核心原理”">​</a></h3><p>MySQL 主从复制基于<strong>二进制日志（binlog）</strong> 实现，核心流程分为 3 步（经典的“三步复制”）：</p><div class="language-mermaid line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    A[主库] --&gt;|1.写入binlog| B(binlog日志)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    C[从库IO线程] --&gt;|2.拉取binlog| B</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    C --&gt;|3.写入relay log| D(relay log中继日志)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    E[从库SQL线程] --&gt;|4.执行relay log| F[从库数据更新]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol><li><strong>主库写入binlog</strong>：主库执行的所有写操作（INSERT/UPDATE/DELETE）都会记录到 binlog；</li><li><strong>从库IO线程拉取binlog</strong>：从库通过 IO 线程连接主库，请求获取 binlog，并将拉取到的内容写入本地 <code>relay log</code>（中继日志）；</li><li><strong>从库SQL线程执行relay log</strong>：从库的 SQL 线程读取 relay log，逐条执行其中的 SQL 语句，实现数据与主库同步。</li></ol><h3 id="_15-2-2-主从复制的核心模式" tabindex="-1">15.2.2 主从复制的核心模式 <a class="header-anchor" href="#_15-2-2-主从复制的核心模式" aria-label="Permalink to “15.2.2 主从复制的核心模式”">​</a></h3><table tabindex="0"><thead><tr><th>复制模式</th><th>同步方式</th><th>数据一致性</th><th>性能</th><th>适用场景</th></tr></thead><tbody><tr><td>异步复制（Async）</td><td>主库写入binlog后立即返回，不等待从库确认</td><td>低（主库宕机可能丢失数据）</td><td>高</td><td>非核心业务、读多写少</td></tr><tr><td>半同步复制（Semi-sync）</td><td>主库需等待至少1个从库确认接收binlog后返回</td><td>中（仅保证binlog传输，不保证执行）</td><td>中</td><td>核心业务、对数据一致性要求较高</td></tr><tr><td>组复制（MGR）</td><td>基于Paxos协议，多数节点确认后才提交</td><td>高（强一致性）</td><td>中低</td><td>核心业务、零数据丢失要求</td></tr></tbody></table><h3 id="_15-2-3-主从复制实战配置-异步复制" tabindex="-1">15.2.3 主从复制实战配置（异步复制） <a class="header-anchor" href="#_15-2-3-主从复制实战配置-异步复制" aria-label="Permalink to “15.2.3 主从复制实战配置（异步复制）”">​</a></h3><h4 id="环境准备" tabindex="-1">环境准备 <a class="header-anchor" href="#环境准备" aria-label="Permalink to “环境准备”">​</a></h4><ul><li>主库：192.168.1.100（MySQL 8.0）</li><li>从库：192.168.1.101（MySQL 8.0）</li><li>核心前提：主从库 MySQL 版本一致、配置文件基本相同、数据初始一致（可通过全量备份恢复）。</li></ul><h4 id="步骤1-主库配置" tabindex="-1">步骤1：主库配置 <a class="header-anchor" href="#步骤1-主库配置" aria-label="Permalink to “步骤1：主库配置”">​</a></h4><ol><li>修改 <code>my.cnf</code> 开启 binlog 并配置唯一 server_id：</li></ol><div class="language-ini line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[mysqld]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 开启binlog（复制必备）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">log_bin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = /var/lib/mysql/mysql-bin</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">binlog_format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = ROW  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 行级复制，数据一致性更高</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">server_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 100  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 唯一标识，不能与从库重复</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 可选：仅复制指定数据库（按需配置）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># binlog_do_db = test_db</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 可选：忽略复制的数据库</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># binlog_ignore_db = mysql</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol start="2"><li>重启主库并创建复制专用账号：</li></ol><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mysqld</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 创建复制账号（仅允许从库IP访问）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> USER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">repl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&#39;@</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;192.168.1.101&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IDENTIFIED </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Repl@123456&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 授予复制权限</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GRANT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> REPLICATION SLAVE, REPLICATION CLIENT </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TO</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;repl&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;192.168.1.101&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">FLUSH PRIVILEGES;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 查看主库binlog状态（记录File和Position，后续从库配置用）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SHOW </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">MASTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> STATUS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 输出示例：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- File: mysql-bin.000001</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Position: 156</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Binlog_Do_DB: test_db</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Binlog_Ignore_DB: mysql</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="步骤2-从库配置" tabindex="-1">步骤2：从库配置 <a class="header-anchor" href="#步骤2-从库配置" aria-label="Permalink to “步骤2：从库配置”">​</a></h4><ol><li>修改 <code>my.cnf</code> 配置 server_id：</li></ol><div class="language-ini line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[mysqld]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">server_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 101  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 与主库不同</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">relay_log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = /var/lib/mysql/relay-bin  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 中继日志（默认开启）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">read_only</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = ON  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 设为只读（仅超级用户可写）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">log_slave_updates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = ON  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 从库执行的复制操作写入自身binlog（便于级联复制）</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="2"><li>重启从库并配置复制：</li></ol><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mysqld</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 停止现有复制（若有）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">STOP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SLAVE;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 配置主库信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CHANGE REPLICATION SOURCE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TO</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SOURCE_HOST </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;192.168.1.100&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SOURCE_USER </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;repl&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SOURCE_PASSWORD </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Repl@123456&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SOURCE_LOG_FILE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;mysql-bin.000001&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,  # 主库SHOW </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">MASTER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> STATUS的File值</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SOURCE_LOG_POS </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 156</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  # 主库SHOW </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">MASTER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> STATUS的Position值</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 启动复制</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">START</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SLAVE;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 查看复制状态（核心）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SHOW SLAVE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">STATUS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\\G;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>关键状态字段（需均为 Yes）：</p><ul><li><code>Slave_IO_Running</code>: Yes（IO线程正常，能拉取主库binlog）</li><li><code>Slave_SQL_Running</code>: Yes（SQL线程正常，能执行relay log）</li><li><code>Seconds_Behind_Master</code>: 0（复制延迟，0表示无延迟）</li></ul><h4 id="步骤3-验证复制" tabindex="-1">步骤3：验证复制 <a class="header-anchor" href="#步骤3-验证复制" aria-label="Permalink to “步骤3：验证复制”">​</a></h4><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 主库插入数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> test_db;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, phone) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;张三&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;13800138000&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 从库查询数据（应能查到新增记录）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> test_db;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;张三&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_15-2-4-半同步复制配置-可选" tabindex="-1">15.2.4 半同步复制配置（可选） <a class="header-anchor" href="#_15-2-4-半同步复制配置-可选" aria-label="Permalink to “15.2.4 半同步复制配置（可选）”">​</a></h3><p>异步复制存在数据丢失风险，核心业务建议开启半同步复制：</p><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 主库安装半同步插件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">INSTALL PLUGIN rpl_semi_sync_master SONAME </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;semisync_master.so&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 开启主库半同步</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> GLOBAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rpl_semi_sync_master_enabled </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 设置超时时间（毫秒，超时后降级为异步）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> GLOBAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rpl_semi_sync_master_timeout </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 从库安装半同步插件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">INSTALL PLUGIN rpl_semi_sync_slave SONAME </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;semisync_slave.so&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 开启从库半同步</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> GLOBAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rpl_semi_sync_slave_enabled </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 重启从库复制线程</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">STOP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SLAVE IO_THREAD;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">START</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SLAVE IO_THREAD;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="_15-3-主从复制的延迟问题与解决方法" tabindex="-1">15.3 主从复制的延迟问题与解决方法 <a class="header-anchor" href="#_15-3-主从复制的延迟问题与解决方法" aria-label="Permalink to “15.3 主从复制的延迟问题与解决方法”">​</a></h2><p>复制延迟是主从架构的常见痛点——从库数据落后于主库，会导致读从库时获取不到最新数据，甚至切换后数据不一致。</p><h3 id="_15-3-1-复制延迟的核心原因" tabindex="-1">15.3.1 复制延迟的核心原因 <a class="header-anchor" href="#_15-3-1-复制延迟的核心原因" aria-label="Permalink to “15.3.1 复制延迟的核心原因”">​</a></h3><ol><li><strong>主库写压力过大</strong>：主库每秒产生大量binlog，从库SQL线程处理不及时；</li><li><strong>从库性能不足</strong>：从库硬件配置低（CPU/内存/IO），无法跟上主库节奏；</li><li><strong>大事务/慢SQL</strong>：主库执行大事务（如批量插入10万行），从库需耗时执行；</li><li><strong>索引缺失</strong>：从库缺少索引，执行复制的SQL时全表扫描；</li><li><strong>网络延迟</strong>：主从库跨机房部署，网络带宽不足或延迟高；</li><li><strong>单SQL线程瓶颈</strong>：传统主从复制仅单SQL线程执行relay log，无法并行处理。</li></ol><h3 id="_15-3-2-复制延迟的监控" tabindex="-1">15.3.2 复制延迟的监控 <a class="header-anchor" href="#_15-3-2-复制延迟的监控" aria-label="Permalink to “15.3.2 复制延迟的监控”">​</a></h3><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 1. 查看从库延迟（核心指标）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Seconds_Behind_Master </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> INFORMATION_SCHEMA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PROCESSLIST</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COMMAND </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Binlog Dump&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 2. 查看复制详细状态（定位延迟原因）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SHOW SLAVE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">STATUS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">\\G;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 关注：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- - Relay_Log_Space：中继日志大小（过大说明SQL线程处理慢）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- - Last_SQL_Error：SQL线程错误（导致复制中断）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- - Master_Log_File/Read_Master_Log_Pos：IO线程已拉取的binlog位置</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- - Relay_Master_Log_File/Exec_Master_Log_Pos：SQL线程已执行的binlog位置</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 3. 开启复制延迟监控（MySQL 8.0+）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> GLOBAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> replication_sender_progress </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> GLOBAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> replication_receiver_progress </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_15-3-3-复制延迟的解决方法" tabindex="-1">15.3.3 复制延迟的解决方法 <a class="header-anchor" href="#_15-3-3-复制延迟的解决方法" aria-label="Permalink to “15.3.3 复制延迟的解决方法”">​</a></h3><h4 id="_1-硬件层面优化" tabindex="-1">1. 硬件层面优化 <a class="header-anchor" href="#_1-硬件层面优化" aria-label="Permalink to “1. 硬件层面优化”">​</a></h4><ul><li>从库配置不低于主库（尤其是CPU和IO，推荐使用SSD）；</li><li>主从库同机房部署，降低网络延迟；</li><li>增大从库内存，提升InnoDB缓冲池命中率。</li></ul><h4 id="_2-配置层面优化" tabindex="-1">2. 配置层面优化 <a class="header-anchor" href="#_2-配置层面优化" aria-label="Permalink to “2. 配置层面优化”">​</a></h4><div class="language-ini line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 从库my.cnf优化</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[mysqld]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 开启并行复制（MySQL 5.7+支持）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">slave_parallel_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = LOGICAL_CLOCK  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 按逻辑时钟并行（基于事务组）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">slave_parallel_workers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 8  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 并行线程数（建议等于CPU核心数）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">slave_preserve_commit_order</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = ON  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 保证事务提交顺序与主库一致</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 增大中继日志缓存</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">relay_log_space_limit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 10G</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 禁用从库二进制日志（若无需级联复制）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># log_bin = OFF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 优化从库SQL执行效率</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">innodb_buffer_pool_size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 8G  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 增大缓冲池</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">innodb_flush_log_at_trx_commit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 2  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 降低刷盘频率（牺牲少量一致性换性能）</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="_3-业务层面优化" tabindex="-1">3. 业务层面优化 <a class="header-anchor" href="#_3-业务层面优化" aria-label="Permalink to “3. 业务层面优化”">​</a></h4><ul><li><strong>拆分大事务</strong>：将主库的大事务拆分为多个小事务（如批量插入拆分为每次1000行）；</li><li><strong>避免慢SQL</strong>：主库执行的SQL需优化（加索引、减少扫描行数），避免从库执行慢；</li><li><strong>读写分离优化</strong>： <ul><li>核心业务的实时查询仍读主库，非实时查询读从库；</li><li>引入中间件（如MyCat、Sharding-JDBC），自动路由实时查询到主库；</li></ul></li><li><strong>延迟容忍设计</strong>：业务层面接受短时间延迟（如5秒），或通过缓存获取最新数据。</li></ul><h4 id="_4-工具层面优化" tabindex="-1">4. 工具层面优化 <a class="header-anchor" href="#_4-工具层面优化" aria-label="Permalink to “4. 工具层面优化”">​</a></h4><ul><li><p>使用 <code>pt-heartbeat</code>（Percona Toolkit）精准监控复制延迟：</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 主库启动心跳</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pt-heartbeat</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --daemonize</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --database</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test_db</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --table</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> heartbeat</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --update</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --master-server-id</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 从库查看延迟（精确到毫秒）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pt-heartbeat</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --database</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test_db</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --table</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> heartbeat</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --monitor</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --slave-server-id</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 101</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ul><h2 id="_15-4-mysql-mgr-组复制-的部署与使用" tabindex="-1">15.4 MySQL MGR（组复制）的部署与使用 <a class="header-anchor" href="#_15-4-mysql-mgr-组复制-的部署与使用" aria-label="Permalink to “15.4 MySQL MGR（组复制）的部署与使用”">​</a></h2><p>MySQL Group Replication（MGR，组复制）是 MySQL 5.7.17 引入的原生高可用集群方案，基于 Paxos 协议实现多节点数据强一致，支持自动故障检测和切换，是核心业务的首选架构。</p><h3 id="_15-4-1-mgr-核心特性" tabindex="-1">15.4.1 MGR 核心特性 <a class="header-anchor" href="#_15-4-1-mgr-核心特性" aria-label="Permalink to “15.4.1 MGR 核心特性”">​</a></h3><ol><li><strong>强一致性</strong>：基于分布式共识算法，多数节点（N/2+1）确认后才提交事务；</li><li><strong>自动故障检测</strong>：集群节点间实时通信，检测故障节点；</li><li><strong>自动故障切换</strong>：主节点故障后，自动选举新主节点；</li><li><strong>多主/单主模式</strong>： <ul><li>单主模式（默认）：仅一个主节点可写，其余为只读；</li><li>多主模式：所有节点均可写（需业务适配，避免写冲突）；</li></ul></li><li><strong>容错性</strong>：N节点集群最多容忍 (N-1)/2 个节点故障（如3节点集群容忍1个故障）。</li></ol><h3 id="_15-4-2-mgr-部署前提" tabindex="-1">15.4.2 MGR 部署前提 <a class="header-anchor" href="#_15-4-2-mgr-部署前提" aria-label="Permalink to “15.4.2 MGR 部署前提”">​</a></h3><ol><li>集群节点：至少3个（推荐奇数，如3/5节点），MySQL版本≥5.7.17（推荐8.0）；</li><li>配置要求： <ul><li>开启 binlog，格式为 ROW；</li><li>关闭 query_cache；</li><li>开启 GTID（全局事务标识）；</li><li>网络互通，节点间能访问3306和33061端口（MGR通信端口）。</li></ul></li></ol><h3 id="_15-4-3-mgr-实战部署-3节点单主集群" tabindex="-1">15.4.3 MGR 实战部署（3节点单主集群） <a class="header-anchor" href="#_15-4-3-mgr-实战部署-3节点单主集群" aria-label="Permalink to “15.4.3 MGR 实战部署（3节点单主集群）”">​</a></h3><h4 id="环境准备-1" tabindex="-1">环境准备 <a class="header-anchor" href="#环境准备-1" aria-label="Permalink to “环境准备”">​</a></h4><ul><li>节点1：192.168.1.100（主节点）</li><li>节点2：192.168.1.101（从节点）</li><li>节点3：192.168.1.102（从节点）</li></ul><h4 id="步骤1-所有节点配置-my-cnf" tabindex="-1">步骤1：所有节点配置 <code>my.cnf</code> <a class="header-anchor" href="#步骤1-所有节点配置-my-cnf" aria-label="Permalink to “步骤1：所有节点配置 my.cnf”">​</a></h4><div class="language-ini line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[mysqld]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 基础配置</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">server_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = 100  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 每个节点不同（100/101/102）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">datadir</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = /var/lib/mysql</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">socket</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = /var/lib/mysql/mysql.sock</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">log_bin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = /var/lib/mysql/mysql-bin</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">binlog_format</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = ROW</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">gtid_mode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = ON</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">enforce_gtid_consistency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = ON</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">log_slave_updates</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = ON</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">skip_slave_start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = ON</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># MGR核心配置</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">transaction_isolation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = READ-COMMITTED  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 隔离级别（MGR要求）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">binlog_checksum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = NONE  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 关闭binlog校验和</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">master_info_repository</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = TABLE</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">relay_log_info_repository</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = TABLE</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">plugin_load_add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;group_replication.so&#39;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 加载MGR插件</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">group_replication_group_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee&#39;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 集群唯一UUID</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">group_replication_start_on_boot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = OFF  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 不随MySQL启动</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">group_replication_local_address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;192.168.1.100:33061&#39;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 每个节点的本地通信地址</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">group_replication_group_seeds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;192.168.1.100:33061,192.168.1.101:33061,192.168.1.102:33061&#39;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # 集群种子节点</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">group_replication_bootstrap_group</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = OFF  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 仅初始化时设为ON</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">group_replication_single_primary_mode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = ON  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 单主模式</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">group_replication_enforce_update_everywhere_checks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> = OFF  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 单主模式设为OFF</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h4 id="步骤2-所有节点创建mgr专用账号" tabindex="-1">步骤2：所有节点创建MGR专用账号 <a class="header-anchor" href="#步骤2-所有节点创建mgr专用账号" aria-label="Permalink to “步骤2：所有节点创建MGR专用账号”">​</a></h4><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CREATE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> USER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mgr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&#39;@</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> IDENTIFIED </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">BY</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;MGR@123456&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">GRANT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> REPLICATION SLAVE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ON</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TO</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;mgr&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;%&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">FLUSH PRIVILEGES;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 配置复制账号（MGR使用）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CHANGE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">MASTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MASTER_USER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;mgr&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, MASTER_PASSWORD</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;MGR@123456&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FOR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CHANNEL </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;group_replication_recovery&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="步骤3-初始化集群-仅节点1执行" tabindex="-1">步骤3：初始化集群（仅节点1执行） <a class="header-anchor" href="#步骤3-初始化集群-仅节点1执行" aria-label="Permalink to “步骤3：初始化集群（仅节点1执行）”">​</a></h4><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 安装MGR插件（若未配置plugin_load_add）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">INSTALL PLUGIN group_replication SONAME </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;group_replication.so&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 启动集群（仅首次初始化）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> GLOBAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> group_replication_bootstrap_group </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">START</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> GROUP_REPLICATION;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> GLOBAL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> group_replication_bootstrap_group </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> OFF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 查看集群状态（节点1应显示为ONLINE）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> performance_schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">replication_group_members</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="步骤4-加入其他节点-节点2、3执行" tabindex="-1">步骤4：加入其他节点（节点2、3执行） <a class="header-anchor" href="#步骤4-加入其他节点-节点2、3执行" aria-label="Permalink to “步骤4：加入其他节点（节点2、3执行）”">​</a></h4><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 安装MGR插件</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">INSTALL PLUGIN group_replication SONAME </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;group_replication.so&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 加入集群</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">START</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> GROUP_REPLICATION;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 查看集群状态（所有节点应显示为ONLINE）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> performance_schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">replication_group_members</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="步骤5-验证集群" tabindex="-1">步骤5：验证集群 <a class="header-anchor" href="#步骤5-验证集群" aria-label="Permalink to “步骤5：验证集群”">​</a></h4><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 主节点（节点1）插入数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> test_db;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">INSERT INTO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, phone) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">VALUES</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;MGR测试&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;13800138000&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 从节点（节点2、3）查询数据（应能查到）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> test_db;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WHERE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> name</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;MGR测试&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 模拟主节点故障（停止节点1的MySQL）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">systemctl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">stop</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mysqld</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 节点2/3会自动选举新主节点，查看新主节点</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> member_role </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> performance_schema</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">replication_group_members</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> member_state </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;ONLINE&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="_15-5-高可用架构中的故障切换实现" tabindex="-1">15.5 高可用架构中的故障切换实现 <a class="header-anchor" href="#_15-5-高可用架构中的故障切换实现" aria-label="Permalink to “15.5 高可用架构中的故障切换实现”">​</a></h2><p>故障切换是高可用架构的核心环节——从“检测故障”到“切换流量”，需保证快速、无数据丢失、业务无感知。</p><h3 id="_15-5-1-故障切换的核心流程" tabindex="-1">15.5.1 故障切换的核心流程 <a class="header-anchor" href="#_15-5-1-故障切换的核心流程" aria-label="Permalink to “15.5.1 故障切换的核心流程”">​</a></h3><div class="language-mermaid line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph TD</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    A[故障检测] --&gt;|1.发现主库宕机/复制异常| B[故障确认]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    B --&gt;|2.多次检测，避免误判| C[停止主库流量]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    C --&gt;|3.禁止业务写入主库| D[数据一致性校验]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    D --&gt;|4.确保从库数据最新| E[提升从库为主库]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    E --&gt;|5.修改从库为可写| F[切换业务流量]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    F --&gt;|6.应用/中间件指向新主库| G[恢复旧主库]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    G --&gt;|7.旧主库作为从库重新加入集群| H[监控验证]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_15-5-2-手动切换-应急场景" tabindex="-1">15.5.2 手动切换（应急场景） <a class="header-anchor" href="#_15-5-2-手动切换-应急场景" aria-label="Permalink to “15.5.2 手动切换（应急场景）”">​</a></h3><p>适用于中小业务或自动化工具故障时的应急操作：</p><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 1. 停止旧主库业务流量（如关闭应用连接）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 2. 确认从库数据最新（延迟为0）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Seconds_Behind_Master </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> INFORMATION_SCHEMA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PROCESSLIST</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> WHERE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> COMMAND </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Binlog Dump&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 3. 停止从库复制</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">STOP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SLAVE;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 4. 将从库设为可写</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SET</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> GLOBAL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> read_only</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> OFF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 5. 修改应用配置，指向新主库（192.168.1.101）</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 6. 旧主库恢复后，作为新从库加入集群</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CHANGE REPLICATION SOURCE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">TO</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SOURCE_HOST </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;192.168.1.101&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SOURCE_USER </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;repl&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SOURCE_PASSWORD </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;Repl@123456&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SOURCE_LOG_FILE </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;mysql-bin.000005&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SOURCE_LOG_POS </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">START</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SLAVE;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_15-5-3-自动切换-生产环境推荐" tabindex="-1">15.5.3 自动切换（生产环境推荐） <a class="header-anchor" href="#_15-5-3-自动切换-生产环境推荐" aria-label="Permalink to “15.5.3 自动切换（生产环境推荐）”">​</a></h3><p>自动切换依赖专用工具，核心分为两类：</p><ol><li><strong>基于VIP的切换（Keepalived）</strong>： <ul><li>主从库绑定同一个VIP（如192.168.1.200）；</li><li>主库故障时，Keepalived将VIP漂移到从库；</li><li>优点：部署简单、切换快；缺点：仅检测节点存活，不校验复制状态，可能导致数据丢失。</li></ul></li><li><strong>基于复制状态的切换（MHA/Orchestrator）</strong>： <ul><li>先校验从库数据一致性，再选择最优从库提升为主库；</li><li>优点：数据一致性高、零丢失；缺点：部署略复杂。</li></ul></li></ol><h2 id="_15-6-常用高可用工具-keepalived、mha-介绍" tabindex="-1">15.6 常用高可用工具（Keepalived、MHA）介绍 <a class="header-anchor" href="#_15-6-常用高可用工具-keepalived、mha-介绍" aria-label="Permalink to “15.6 常用高可用工具（Keepalived、MHA）介绍”">​</a></h2><h3 id="_15-6-1-keepalived-轻量级vip漂移工具" tabindex="-1">15.6.1 Keepalived：轻量级VIP漂移工具 <a class="header-anchor" href="#_15-6-1-keepalived-轻量级vip漂移工具" aria-label="Permalink to “15.6.1 Keepalived：轻量级VIP漂移工具”">​</a></h3><p>Keepalived 基于 VRRP 协议实现 VIP 高可用，适合中小业务的主从架构快速切换。</p><h4 id="核心配置-主库-keepalived-conf" tabindex="-1">核心配置（主库 <code>keepalived.conf</code>） <a class="header-anchor" href="#核心配置-主库-keepalived-conf" aria-label="Permalink to “核心配置（主库 keepalived.conf）”">​</a></h4><div class="language-conf line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>global_defs {</span></span>
<span class="line"><span>   router_id mysql_master  # 唯一标识</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>vrrp_instance VI_1 {</span></span>
<span class="line"><span>    state MASTER  # 主库设为MASTER，从库设为BACKUP</span></span>
<span class="line"><span>    interface eth0  # 网卡名称</span></span>
<span class="line"><span>    virtual_router_id 51  # 虚拟路由ID（主从一致）</span></span>
<span class="line"><span>    priority 100  # 优先级（主库高于从库，如从库设为90）</span></span>
<span class="line"><span>    advert_int 1  # 心跳间隔（秒）</span></span>
<span class="line"><span>    authentication {</span></span>
<span class="line"><span>        auth_type PASS</span></span>
<span class="line"><span>        auth_pass 1111  # 认证密码（主从一致）</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    virtual_ipaddress {</span></span>
<span class="line"><span>        192.168.1.200/24  # 虚拟IP（VIP）</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="核心特点" tabindex="-1">核心特点 <a class="header-anchor" href="#核心特点" aria-label="Permalink to “核心特点”">​</a></h4><ul><li><strong>优点</strong>：部署简单、切换速度快（秒级）、资源占用低；</li><li><strong>缺点</strong>： <ul><li>仅检测节点存活（ping通即认为正常），不校验MySQL服务和复制状态；</li><li>不支持多从库选择，仅能切换到指定从库；</li><li>可能出现“脑裂”（主从库同时持有VIP），需配置抢占模式和延迟。</li></ul></li></ul><h3 id="_15-6-2-mha-专业mysql高可用工具" tabindex="-1">15.6.2 MHA：专业MySQL高可用工具 <a class="header-anchor" href="#_15-6-2-mha-专业mysql高可用工具" aria-label="Permalink to “15.6.2 MHA：专业MySQL高可用工具”">​</a></h3><p>MHA（Master High Availability）是由日本DeNA公司开发的开源工具，专为MySQL主从架构设计，支持自动故障检测、最优从库选择、零数据丢失切换。</p><h4 id="核心组件" tabindex="-1">核心组件 <a class="header-anchor" href="#核心组件" aria-label="Permalink to “核心组件”">​</a></h4><ul><li><strong>MHA Manager</strong>：管理节点，负责故障检测和切换；</li><li><strong>MHA Node</strong>：数据节点，部署在所有主从库上，负责复制管理和数据修复。</li></ul><h4 id="核心特点-1" tabindex="-1">核心特点 <a class="header-anchor" href="#核心特点-1" aria-label="Permalink to “核心特点”">​</a></h4><ul><li><strong>自动故障检测</strong>：实时监控主库状态，支持自定义检测脚本；</li><li><strong>智能从库选择</strong>：优先选择复制延迟最小、数据最新的从库提升为主库；</li><li><strong>零数据丢失</strong>：从主库残留的binlog中恢复未复制的数据；</li><li><strong>在线切换</strong>：支持手动触发主从切换（如主库维护）；</li><li><strong>缺点</strong>： <ul><li>仅支持MySQL 5.5-5.7（8.0需适配）；</li><li>部署和配置较复杂；</li><li>不支持MGR集群。</li></ul></li></ul><h4 id="部署参考" tabindex="-1">部署参考 <a class="header-anchor" href="#部署参考" aria-label="Permalink to “部署参考”">​</a></h4><p>MHA 官方文档：<a href="https://code.google.com/archive/p/mysql-master-ha/%EF%BC%88%E9%9C%80%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91%EF%BC%89" target="_blank" rel="noreferrer">https://code.google.com/archive/p/mysql-master-ha/（需科学上网）</a><br> Percona 维护的 MHA 分支：<a href="https://github.com/percona/mha4mysql-manager" target="_blank" rel="noreferrer">https://github.com/percona/mha4mysql-manager</a></p><h3 id="_15-6-3-其他工具推荐" tabindex="-1">15.6.3 其他工具推荐 <a class="header-anchor" href="#_15-6-3-其他工具推荐" aria-label="Permalink to “15.6.3 其他工具推荐”">​</a></h3><table tabindex="0"><thead><tr><th>工具</th><th>定位</th><th>适用场景</th></tr></thead><tbody><tr><td>Orchestrator</td><td>可视化MySQL拓扑管理工具</td><td>中大型主从集群、支持自动切换和拓扑重构</td></tr><tr><td>ProxySQL</td><td>数据库中间件，支持读写分离和自动切换</td><td>高并发读写分离场景、需动态路由流量</td></tr><tr><td>MySQL Router</td><td>官方中间件，适配MGR集群</td><td>MGR集群的流量路由、自动感知节点状态</td></tr><tr><td>Zookeeper + Kafka</td><td>分布式协调，实现高可用切换</td><td>大型分布式架构、多集群联动切换</td></tr></tbody></table><h3 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to “总结”">​</a></h3><ol><li>高可用架构的核心是满足 RTO/RPO 目标，中小业务可选择主从+Keepalived，核心业务推荐 MGR 集群；</li><li>主从复制是高可用的基础，需关注复制延迟问题，通过并行复制、硬件升级、业务优化解决；</li><li>MGR 是 MySQL 原生高可用方案，基于 Paxos 实现强一致性，适合核心业务，但对网络和配置要求高；</li><li>故障切换需保证“数据一致性优先”，手动切换仅用于应急，生产环境推荐 MHA/Orchestrator 等专业工具；</li><li>高可用架构不是“部署完成就一劳永逸”，需定期演练故障切换，验证切换成功率和数据一致性。</li></ol><p>MySQL 高可用的本质是“风险兜底”——架构设计需结合业务实际，平衡可用性、一致性和运维成本，最终实现“故障无感知、数据不丢失、业务不中断”的目标。</p>`,106)])])}const b=i(e,[["render",p]]);export{E as __pageData,b as default};
